<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coș de Cumpărături - Red by Luxury</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">
                <h1><a href="/">RED <span>by Luxury</span></a></h1>
                <p>Parfumuri de Lux</p>
            </div>
            <nav>
                <ul>
                    <li><a href="/">Acasă</a></li>
                    <li><a href="/Red-by-Luxury/products.html">Produse</a></li>
                    <li><a href="/Red-by-Luxury/about.html">Despre Noi</a></li>
                    <li><a href="/Red-by-Luxury/contact.html">Contact</a></li>
                </ul>
            </nav>
            <div class="header-icons">
                <a href="/Red-by-Luxury/search.html"><i class="fas fa-search"></i></a>
                <a href="/Red-by-Luxury/cart.html" class="cart-icon active">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="cart-count">0</span>
                </a>
                <a href="/Red-by-Luxury/account.html"><i class="fas fa-user"></i></a>
            </div>
        </div>
    </header>

    <!-- Cart Section -->
    <section class="cart-page">
        <div class="container">
            <h2>Coș de Cumpărături</h2>
            <div class="cart-content">
                <div class="cart-items" id="cart-items-container">
                    <!-- Produsele din coș vor fi afișate aici -->
                    <div class="empty-cart">
                        <i class="fas fa-shopping-bag"></i>
                        <h3>Coșul tău este gol</h3>
                        <p>Nu ai niciun produs în coșul de cumpărături.</p>
                        <a href="/Red-by-Luxury/products.html" class="btn-primary">Continuă Cumpărăturile</a>
                    </div>
                </div>
                
                <div class="cart-summary">
                    <h3>Sumar Comandă</h3>
                    <div class="summary-item">
                        <span>Subtotal</span>
                        <span id="subtotal">0 lei</span>
                    </div>
                    <div class="summary-item">
                        <span>Livrare</span>
                        <span>Gratuită</span>
                    </div>
                    <div class="summary-total">
                        <span>Total</span>
                        <span id="total">0 lei</span>
                    </div>
                    <button class="btn-primary" id="checkout-button">Finalizează Comanda</button>
                    <div class="payment-methods">
                        <p>Metode de plată acceptate:</p>
                        <div class="payment-icons">
                            <i class="fab fa-cc-visa"></i>
                            <i class="fab fa-cc-mastercard"></i>
                            <i class="fab fa-cc-amex"></i>
                            <i class="fab fa-cc-paypal"></i>
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>RED <span>by Luxury</span></h3>
                    <p>Parfumuri de lux create pentru oameni excepționali</p>
                    <div class="social-icons">
                        <a href="https://www.facebook.com" target="_blank"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://www.instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
                        <a href="https://www.pinterest.com" target="_blank"><i class="fab fa-pinterest-p"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Linkuri Utile</h4>
                    <ul>
                        <li><a href="/">Acasă</a></li>
                        <li><a href="/Red-by-Luxury/products.html">Produse</a></li>
                        <li><a href="/Red-by-Luxury/about.html">Despre Noi</a></li>
                        <li><a href="/Red-by-Luxury/contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p><i class="fas fa-map-marker-alt"></i> Bulevardul Eleganței 10, București</p>
                    <p><i class="fas fa-phone"></i> +40 721 000 000</p>
                    <p><i class="fas fa-envelope"></i> contact@redbyluxury.ro</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2023 Red by Luxury. Toate drepturile rezervate.</p>
            </div>
        </div>
    </footer>

    <!-- Success Modal -->
    <div class="success-overlay" id="success-overlay">
        <div class="success-modal">
            <div class="success-content">
                <i class="fas fa-check-circle"></i>
                <h3>Comandă Finalizată cu Succes!</h3>
                <p>Vă mulțumim că ați ales Red by Luxury. Un email cu detalii comenzii a fost trimis către dumneavoastră.</p>
                <button class="btn-primary" id="continue-shopping">Continuă Cumpărăturile</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Inițializare Stripe
        const stripe = Stripe('pk_test_51S2tMZGdE7oRFon7Op95iLZbRo87irRPDiyDHpEhLHVlDsdfcFznLwoh2hePb1yGOGuLh2glp1FFgl6DSKVFr0qH00xTtF0J0z');
        
        // Funcție pentru actualizarea sumarului coșului
        function updateCartSummary(subtotal, total) {
            document.getElementById('subtotal').textContent = `${subtotal.toFixed(2)} lei`;
            document.getElementById('total').textContent = `${total.toFixed(2)} lei`;
        }
        
        // Funcție pentru actualizarea cantității
        function updateQuantity(id, change) {
            try {
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                const itemIndex = cart.findIndex(item => item.id === id);
                
                if (itemIndex !== -1) {
                    // Asigurăm că quantity este un număr valid
                    const currentQuantity = parseInt(cart[itemIndex].quantity) || 0;
                    cart[itemIndex].quantity = Math.max(0, currentQuantity + change);
                    
                    if (cart[itemIndex].quantity <= 0) {
                        cart.splice(itemIndex, 1);
                    }
                    
                    localStorage.setItem('cart', JSON.stringify(cart));
                    loadCart();
                    if (typeof window.updateCartCount === 'function') {
                        window.updateCartCount();
                    }
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
            }
        }
        
        // Funcție pentru eliminarea unui produs din coș
        function removeFromCart(id) {
            try {
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                cart = cart.filter(item => item.id !== id);
                localStorage.setItem('cart', JSON.stringify(cart));
                loadCart();
                if (typeof window.updateCartCount === 'function') {
                    window.updateCartCount();
                }
            } catch (error) {
                console.error('Error removing from cart:', error);
            }
        }
        
        // Funcție pentru încărcarea coșului
        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const container = document.getElementById('cart-items-container');
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-bag"></i>
                        <h3>Coșul tău este gol</h3>
                        <p>Nu ai niciun produs în coșul de cumpărături.</p>
                        <a href="/products.html" class="btn-primary">Continuă Cumpărăturile</a>
                    </div>
                `;
                updateCartSummary(0, 0);
                return;
            }
            
            container.innerHTML = '';
            let subtotal = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-image">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="cart-item-details">
                        <h4>${item.name}</h4>
                        <div class="price">${item.price} lei</div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn decrease" data-id="${item.id}">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn increase" data-id="${item.id}">+</button>
                        </div>
                        <div class="cart-item-total">${itemTotal.toFixed(2)} lei</div>
                        <button class="remove-item" data-id="${item.id}">
                            <i class="fas fa-trash"></i> Elimină
                        </button>
                    </div>
                `;
                
                container.appendChild(cartItem);
            });
            
            // Adăugare event listeners pentru butoanele de cantitate și eliminare
            document.querySelectorAll('.quantity-btn.decrease').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    updateQuantity(id, -1);
                });
            });
            
            document.querySelectorAll('.quantity-btn.increase').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    updateQuantity(id, 1);
                });
            });
            
            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    removeFromCart(id);
                });
            });
            
            updateCartSummary(subtotal, subtotal);
        }
        
        // Funcție pentru finalizarea comenzii
        async function handleCheckout() {
            // Curățăm coșul de produse cu quantity invalid
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            
            // Filtrăm produsele cu quantity valid și corectăm valorile
            cart = cart.map(item => ({
                ...item,
                quantity: Math.max(1, parseInt(item.quantity) || 1)
            })).filter(item => item.quantity > 0);
            
            // Salvăm coșul curățat
            localStorage.setItem('cart', JSON.stringify(cart));
            
            if (cart.length === 0) {
                alert('Coșul este gol!');
                return;
            }
            
            try {
                // Creare elemente pentru Stripe
                const lineItems = cart.map(item => ({
                    price_data: {
                        currency: 'ron',
                        product_data: {
                            name: item.name,
                        },
                        unit_amount: Math.round(item.price * 100), // Convertim la bani
                    },
                    quantity: item.quantity,
                }));
                
                // Creare sesiune de plată
                const response = await fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: lineItems
                    })
                });
                
                // Verificăm dacă răspunsul este OK
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Eroare la crearea sesiunii de plată');
                }
                
                const session = await response.json();
                
                if (session.error) {
                    throw new Error(session.error);
                }
                
                // Redirecționare către Stripe Checkout
                const { error } = await stripe.redirectToCheckout({
                    sessionId: session.id
                });
                
                if (error) {
                    console.error('Error:', error);
                    alert('A apărut o eroare la procesarea plății. Vă rugăm încercați din nou.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('A apărut o eroare: ' + error.message);
            }
        }
        
        // Verificați dacă funcția există înainte de a o apela
        document.addEventListener('DOMContentLoaded', function() {
            // Încărcare coș din localStorage
            loadCart();
            if (typeof window.updateCartCount === 'function') {
                window.updateCartCount();
            } else {
                // Definim funcția dacă nu există
                window.updateCartCount = function() {
                    try {
                        const cart = JSON.parse(localStorage.getItem('cart')) || [];
                        const totalItems = cart.reduce((total, item) => total + (parseInt(item.quantity) || 0), 0);
                        const cartCount = document.querySelector('.cart-count');
                        if (cartCount) {
                            cartCount.textContent = totalItems;
                        }
                    } catch (error) {
                        console.error('Error updating cart count:', error);
                    }
                };
                window.updateCartCount();
            }
            
            // Event listener pentru butonul de finalizare comandă
            document.getElementById('checkout-button').addEventListener('click', handleCheckout);
            
            // Event listener pentru butonul de continuare cumpărături
            document.getElementById('continue-shopping').addEventListener('click', function() {
                document.getElementById('success-overlay').style.display = 'none';
            });
            
            // Verificare dacă avem un succes de plată în URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success')) {
                document.getElementById('success-overlay').style.display = 'flex';
                // Ștergem parametrul din URL
                window.history.replaceState({}, document.title, "/");
            }
        });
    </script>
</body>
</html>
